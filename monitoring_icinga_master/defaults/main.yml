---

#
# Substitutes - do not change
#

#
# The following variables are handled by icinga_common:
#  - icinga_node_name
#  - icinga_ticket_salt
#  - icinga_constants
#  - icinga_includes
#  - icinga_zones
#  - icinga_endpoints
#

monitoring_icinga_master__configuration_files_absent: "{{ icinga_configuration_files_absent | default(monitoring_icinga_master__configuration_files_absent_default) }}"
monitoring_icinga_master__features_enabled: "{{ icinga_features_enabled | default(monitoring_icinga_master__features_enabled_default) }}"
monitoring_icinga_master__configuration_files: "{{ icinga_configuration_files | default(monitoring_icinga_master__configuration_files_default) }}"

monitoring_icinga_master__api_users: "{{ icinga_api_users | default([]) }}"
monitoring_icinga_master__hosts: "{{ icinga_hosts | default([]) }}"
monitoring_icinga_master__services: "{{ icinga_services | default(monitoring_icinga_master__services_default) }}"
monitoring_icinga_master__templates: "{{ icinga_templates | default(monitoring_icinga_master__templates_default) }}"
monitoring_icinga_master__zone_hosts: "{{ icinga_zone_hosts | default({}) }}"
monitoring_icinga_master__zone_services: "{{ icinga_zone_services | default({}) }}"

monitoring_icinga_master__mysql_enabled: "{{ icinga_mysql | default(false) }}"
monitoring_icinga_master__pgsql_enabled: "{{ icinga_pgsql | default(false) }}"

monitoring_icinga_master__api_accept_config: "{{ icinga_api_accept_config | default(true) }}"
monitoring_icinga_master__api_accept_commands: "{{ icinga_api_accept_commands | default(true) }}"
monitoring_icinga_master__api_bind_host: "{{ icinga_api_bind_host | default('localhost') }}"
monitoring_icinga_master__api_bind_port: "{{ icinga_api_bind_port | default(5665) }}"

monitoring_icinga_master__mysql_user: "{{ icinga_mysql_user | default('icinga') }}"
monitoring_icinga_master__mysql_password: "{{ icinga_mysql_password | mandatory }}"
monitoring_icinga_master__mysql_host: "{{ icinga_mysql_host | default('localhost') }}"
monitoring_icinga_master__mysql_database: "{{ icinga_mysql_database | default('icinga') }}"

#
# Defaults - do not change
#

monitoring_icinga_master__user: "{{ monitoring_icinga_common__user }}"
monitoring_icinga_master__group: "{{ monitoring_icinga_common__group }}"

monitoring_icinga_master__crt_dir: "{{ monitoring_icinga_common__crt_dir }}"
monitoring_icinga_master__etc_dir: "{{ monitoring_icinga_common__etc_dir }}"
monitoring_icinga_master__conf_dir: "{{ monitoring_icinga_common__conf_dir }}"
monitoring_icinga_master__zones_dir: "{{ monitoring_icinga_common__etc_dir }}/zones.d"

monitoring_icinga_master__node_name: "{{ monitoring_icinga_common__node_name }}"

monitoring_icinga_master__main_log_file: "{{ monitoring_icinga_common__main_log_file }}"
monitoring_icinga_master__main_log_severity: "{{ monitoring_icinga_common__main_log_severity }}"
monitoring_icinga_master__debug_log_file: "{{ monitoring_icinga_common__debug_log_file }}"
monitoring_icinga_master__debug_log_severity: "{{ monitoring_icinga_common__debug_log_severity }}"

monitoring_icinga_master__constants: "{{ monitoring_icinga_common__constants }}"
monitoring_icinga_master__includes: "{{ monitoring_icinga_common__includes }}"
monitoring_icinga_master__endpoints: "{{ monitoring_icinga_common__endpoints }}"
monitoring_icinga_master__zones: "{{ monitoring_icinga_common__zones }}"

monitoring_icinga_master__certificate_files: "{{ monitoring_icinga_common__certificate_files }}"

monitoring_icinga_master__configuration_files_absent_default:
  - "{{ monitoring_icinga_master__etc_dir }}/conf.d/apt.conf"
  - "{{ monitoring_icinga_master__etc_dir }}/conf.d/commands.conf"
  - "{{ monitoring_icinga_master__etc_dir }}/conf.d/downtimes.conf"
  - "{{ monitoring_icinga_master__etc_dir }}/conf.d/groups.conf"
  - "{{ monitoring_icinga_master__etc_dir }}/conf.d/notifications.conf"
  - "{{ monitoring_icinga_master__etc_dir }}/conf.d/timeperiods.conf"
  - "{{ monitoring_icinga_master__etc_dir }}/conf.d/users.conf"

monitoring_icinga_master__features_enabled_mysql: "{{ [ 'ido-mysql' ] if monitoring_icinga_master__mysql_enabled else [] }}"

monitoring_icinga_master__features_enabled_pgsql: "{{ [ 'ido-pgsql' ] if monitoring_icinga_master__pgsql_enabled else [] }}"

monitoring_icinga_master__features_enabled_default: "{{ [
  'api',
  'checker',
  'mainlog',
  'notification'
] +
    monitoring_icinga_master__features_enabled_mysql +
    monitoring_icinga_master__features_enabled_pgsql
}}"

monitoring_icinga_master__configuration_files_mysql: "{{ [ 
  { 'src': 'ido-mysql.conf.j2', 'dest': monitoring_icinga_common__features_available_dir + '/ido-mysql.conf' }
] if monitoring_icinga_master__mysql_enabled else [] }}"

monitoring_icinga_master__configuration_files_pgsql: "{{ [ 
  { 'src': 'ido-pgsql.conf.j2', 'dest': monitoring_icinga_common__features_available_dir + '/ido-pgsql.conf' }
] if monitoring_icinga_master__pgsql_enabled else [] }}"

monitoring_icinga_master__configuration_files_default: "{{ [ 
  { 'src': 'api-users.conf.j2', 'dest': monitoring_icinga_master__conf_dir + '/api-users.conf', 'mode': '600' },
  { 'src': 'app.conf.j2', 'dest': monitoring_icinga_master__conf_dir + '/app.conf' },
  { 'src': 'hosts.conf.j2', 'dest': monitoring_icinga_master__conf_dir + '/hosts.conf' },
  { 'src': 'services.conf.j2', 'dest': monitoring_icinga_master__conf_dir + '/services.conf' },
  { 'src': 'templates.conf.j2', 'dest': monitoring_icinga_master__conf_dir + '/templates.conf' },
  { 'src': 'api.conf.j2', 'dest': monitoring_icinga_common__features_available_dir + '/api.conf' },
  { 'src': 'checker.conf.j2', 'dest': monitoring_icinga_common__features_available_dir + '/checker.conf' },
  { 'src': 'debuglog.conf.j2', 'dest': monitoring_icinga_common__features_available_dir + '/debuglog.conf' },
  { 'src': 'mainlog.conf.j2', 'dest': monitoring_icinga_common__features_available_dir + '/mainlog.conf' },
  { 'src': 'notification.conf.j2', 'dest': monitoring_icinga_common__features_available_dir + '/notification.conf' },
  { 'src': 'constants.conf.j2', 'dest': monitoring_icinga_master__etc_dir + '/constants.conf' },
  { 'src': 'icinga2.conf.j2', 'dest': monitoring_icinga_master__etc_dir + '/icinga2.conf' },
  { 'src': 'zones.conf.j2', 'dest': monitoring_icinga_master__etc_dir + '/zones.conf' }
] +
    monitoring_icinga_master__configuration_files_mysql +
    monitoring_icinga_master__configuration_files_pgsql
}}"

monitoring_icinga_master__services_default:
  - name: ping4
    import:
      - generic-service
    check_command: ping4
    assign:
      - host.address
  - name: ping6
    import:
      - generic-service
    check_command: ping6
    assign:
      - host.address6
  - name: ssh
    import:
      - generic-service
    check_command: ssh
    assign:
      - (host.address || host.address6) && host.vars.os == "Linux"
  - for: http_vhost => config in host.vars.http_vhosts
    import:
      - generic-service
    check_command: http
    options:
      - vars += config
  - for: disk => config in host.vars.disks
    import:
      - generic-service
    check_command: disk
    options:
      - vars += config
  - name: icinga
    import:
      - generic-service
    check_command: icinga
    assign:
      - host.name == NodeName
  - name: load
    import:
      - generic-service
    check_command: load
    vars:
      - key: backup_downtime
        value: '"02:00-03:00"'
    assign:
      - host.name == NodeName
  - name: procs
    import:
      - generic-service
    check_command: procs
    assign:
      - host.name == NodeName
  - name: swap
    import:
      - generic-service
    check_command: swap
    assign:
      - host.name == NodeName
  - name: users
    import:
      - generic-service
    check_command: users
    assign:
      - host.name == NodeName

monitoring_icinga_master__templates_default:
  - name: generic-host
    object: Host
    max_check_attempts: 3
    check_interval: 1m
    retry_interval: 30s
    check_command: hostalive
  - name: generic-service
    object: Service
    max_check_attempts: 5
    check_interval: 1m
    retry_interval: 30s

monitoring_icinga_master__packages_mysql:
  Debian: "{{ [ 
    'icinga2-ido-mysql',
    'default-mysql-client',
    'libdbd-mysql-perl'
] if monitoring_icinga_master__mysql_enabled else [] }}"

monitoring_icinga_master__packages_pgsql:
  Debian: "{{ [ 
    'icinga2-ido-pgsql',
    'postgresql-client'
] if monitoring_icinga_master__pgsql_enabled else [] }}"

monitoring_icinga_master__packages: "{{ monitoring_icinga_master__packages_default[bootstrap_ansible__distribution] | default([]) }}"

monitoring_icinga_master__packages_default:
  Debian: "{{ [ 
    'icinga2',
    'icinga2-bin',
    'icinga2-common',
    'monitoring-plugins',
    'monitoring-plugins-basic',
    'monitoring-plugins-common',
    'monitoring-plugins-standard',
    'libnet-snmp-perl'
] +
    monitoring_icinga_master__packages_mysql[bootstrap_ansible__distribution] +
    monitoring_icinga_master__packages_pgsql[bootstrap_ansible__distribution]
}}"
