---
# tasks file for roles/bootstrap

- name: Create Ansible state directory
  tags: [ bootstrap ]
  ansible.builtin.file:
    dest: /etc/ansible
    state: directory
    owner: root
    group: root
    mode: 0750

- name: Set hostname
  tags: [ bootstrap, configuration ]
  when: bootstrap__hostname | length > 0
  ansible.builtin.copy:
    dest: /etc/hostname
    content: |
      {{ bootstrap__hostname }}
    owner: root
    group: root
    mode: 0644

- name: Generate sysctl configuration
  tags: [ bootstrap, configuration ]
  ansible.builtin.template:
    src: etc/sysctl.conf.j2
    dest: /etc/sysctl.conf
    owner: root
    group: root
    mode: 0644

- name: Generate resolver configuration
  tags: [ bootstrap, configuration ]
  when: bootstrap__resolv_enable
  include_tasks: resolv.yml

- name: Configure grub
  tags: [ bootstrap, configuration ]
  when: bootstrap__grub_enable
  include_tasks: grub.yml

- name: Configure keyboard
  tags: [ bootstrap, configuration ]
  ansible.builtin.template:
    src: etc/default/keyboard.j2
    dest: /etc/default/keyboard
    owner: root
    group: root
    mode: 0644
  vars:
    keyboard_xkbmodel: "{{ bootstrap__keyboard_xkbmodel }}"
    keyboard_xkblayout: "{{ bootstrap__keyboard_xkblayout }}"
    keyboard_xkbvariant: "{{ bootstrap__keyboard_xkbvariant }}"
    keyboard_xkboptions: "{{ bootstrap__keyboard_xkboptions }}"
    keyboard_backspace: "{{ bootstrap__keyboard_backspace }}"

- name: Configure locale variables
  tags: [ bootstrap, configuration ]
  ansible.builtin.template:
    src: etc/default/locale.j2
    dest: /etc/default/locale
    owner: root
    group: root
    mode: 0644
  vars:
    locale_vars: "{{ bootstrap__locale_vars_combined }}"

- name: Configure locale.gen
  tags: [ bootstrap, configuration ]
  ansible.builtin.template:
    src: etc/locale.gen.j2
    dest: /etc/locale.gen
    owner: root
    group: root
    mode: 0644
  vars:
    locales: "{{ bootstrap__locales_combined }}"
  notify:
  - Generate locales

- name: Flush handlers
  meta: flush_handlers

- name: Generate hosts
  tags: [ bootstrap, configuration ]
  ansible.builtin.template:
    src: etc/hosts.j2
    dest: /etc/hosts
    owner: root
    group: root
    mode: 0644
  vars:
    hosts: "{{ bootstrap__hosts }}"

- name: Configure timezone
  tags: [ bootstrap, configuration ]
  ansible.builtin.copy:
    dest: /etc/timezone
    content: |
      {{ bootstrap__timezone }}
    owner: root
    group: root
    mode: 0644

- name: Configure localtime
  tags: [ bootstrap, configuration ]
  ansible.builtin.file:
    src: "/usr/share/zoneinfo/{{ bootstrap__timezone }}"
    dest: /etc/localtime
    state: link

- name: Copy screen configuration
  tags: [ bootstrap, configuration ]
  ansible.builtin.copy:
    src: screenrc
    dest: /root/.screenrc
    mode: 0644

- name: Install default packages
  tags: [ bootstrap, packages ]
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  with_items: "{{ bootstrap__packages_combined }}"

- name: Generate aliases file
  tags: [ 'configuration' ]
  when: bootstrap__aliases | length > 0
  ansible.builtin.template:
    src: etc/aliases.j2
    dest: /etc/aliases
    owner: root
    group: root
    mode: 0644

- name: Create networking configuration
  tags: [ 'network', 'configuration' ]
  when: bootstrap__network_enable
  include_tasks: network.yml

- name: Add user and group accounts
  tags: [ 'network', 'account' ]
  when: bootstrap__group | length > 0 or bootstrap__user | length > 0
  include_tasks: accounts.yml

- name: Add storages
  tags: [ 'network', 'mount' ]
  when: bootstrap__storage | length > 0
  include_tasks: storage.yml

- name: Add bind mounts
  tags: [ 'network', 'mount' ]
  when: bootstrap__mount | length > 0
  include_tasks: nullfs.yml

- name: Enable & disable systemd services
  tags: [ 'network', 'service' ]
  when: bootstrap__systemd_services | length > 0
  include_tasks: systemd.yml
