---
# defaults file for roles/postgresql

postgresql_client_packages: []
postgresql_server_packages: []
postgresql_server_hba: []

#
# Substitutions
#

postgresql__enable: "{{ postgresql_enable | default (false) }}"
postgresql__client_enable: "{{ postgresql_client_enable | default (postgresql__enable or postgresql__server_enable) }}"
postgresql__server_enable: "{{ postgresql_server_enable | default (postgresql__enable) }}"
postgresql__accounts: "{{ postgresql_accounts | default ([]) }}"
postgresql__databases: "{{ postgresql_databases | default ([]) }}"
postgresql__password: "{{ vault__postgresql_password | default({}) }}"

postgresql__version: "{{ postgresql_version | default(12) }}"

postgresql__server_hba: "{{ postgresql_server_hba | default(postgresql__server_hba_default) }}"

postgresql__server_instance: "{{ postgresql_server_instance | default(postgresql__version + '/main') }}"
postgresql__server_lc_all: "{{ postgresql_server_lc_all | default('C') }}"
postgresql__server_etc_path: "{{ postgresql_server_etc_path | default('/etc/postgresql') }}"
postgresql__server_lib_path: "{{ postgresql_server_lib_path | default('/var/lib/postgresql') }}"
postgresql__server_run_path: "{{ postgresql_server_run_path | default('/var/run/postgresql') }}"

postgresql__server_data_directory: "{{ postgresql_server_data_directory | default(postgresql__server_lib_path + '/' + postgresql__server_instance) }}"
postgresql__server_hba_file: "{{ postgresql_server_hba_file | default(postgresql__server_etc_path + '/' + postgresql__server_instance +'/pg_hba.conf') }}"
postgresql__server_ident_file: "{{ postgresql_server_ident_file | default(postgresql__server_etc_path + '/' + postgresql__server_instance +'/pg_ident.conf') }}" 
postgresql__server_external_pid_file: "{{ postgresql_server_external_pid_file | default(postgresql__server_run_path + '/' + postgresql__version + '-main.pid') }}"
postgresql__server_listen_addresses: "{{ postgresql_server_listen_addresses | default(['localhost']) }}"
postgresql__server_port: "{{ postgresql_server_port | default('5432') }}"
postgresql__server_max_connections: "{{ postgresql_server_max_connections | default('100') }}"
postgresql__server_unix_socket_directories: "{{ postgresql_server_unix_socket_directories | default(postgresql__server_run_path) }}"
postgresql__server_ssl: "{{ postgresql_server_ssl | default(false)) }}"
postgresql__server_ssl_cert_file: "{{ postgresql_server_ssl_cert_file | default('') }}"
postgresql__server_ssl_key_file: "{{ postgresql_server_ssl_key_file | default('') }}" 
postgresql__server_shared_buffers: "{{ postgresql_server_shared_buffers | default('128MB') }}"
postgresql__server_dynamic_shared_memory_type: "{{ postgresql_server_dynamic_shared_memory_type | default('posix') }}"
postgresql__server_max_wal_size: "{{ postgresql_server_max_wal_size | default('1GB') }}"
postgresql__server_min_wal_size: "{{ postgresql_server_min_wal_size | default('80MB') }}"
postgresql__server_log_line_prefix: "{{ postgresql_server_log_line_prefix | default('%m [%p] ') }}"
postgresql__server_log_timezone: "{{ postgresql_server_log_timezone | default(postgresql__server_timezone) }}"
postgresql__server_cluster_name: "{{ postgresql_server_cluster_name | default(postgresql__server_instance) }}"
postgresql__server_stats_temp_directory: "{{ postgresql_server_stats_temp_directory | default(postgresql__server_run_path + '/' + postgresql__version + '-main.pg_stat_tmp') }}"
postgresql__server_datestyle: "{{ postgresql_server_datestyle | default('iso, mdy') }}"
postgresql__server_timezone: "{{ postgresql_server_timezone | default('GMT') }}"
postgresql__server_lc_messages: "{{ postgresql_server_lc_messages | default(postgresql_server_lc_all) }}"
postgresql__server_lc_monetary: "{{ postgresql_server_lc_monetary | default(postgresql_server_lc_all) }}"
postgresql__server_lc_numeric: "{{ postgresql_server_lc_numeric | default(postgresql_server_lc_all) }}"
postgresql__server_lc_time: "{{ postgresql_server_lc_time | default(postgresql_server_lc_all) }}"
postgresql__server_default_text_search_config: "{{ postgresql_server_default_text_search_config | default('pg_catalog.english') }}"
postgresql__server_include_dir: "{{ postgresql_server_include_dir | default('conf.d') }}"

#
# Do not change from here
#

postgresql__client_packages_default: "{{ postgresql__client_packages_versions[postgresql__version] }}"

postgresql__client_packages_versions:
  '12':
  - postgresql-client-12
  - postgresql-client-common
  '13':
  - postgresql-client-13
  - postgresql-client-common

postgresql__server_packages_default:  "{{ postgresql__server_packages_versions[postgresql__version] }}"

postgresql__server_packages_versions:
  '12':
  - postgresql-12
  - postgresql-common
  '13':
  - postgresql-13
  - postgresql-common

postgresql__client_packages_combined: "{{ postgresql__client_packages_default + postgresql_client_packages}}"
postgresql__server_packages_combined: "{{ postgresql__server_packages_default + postgresql_server_packages}}"

postgresql__server_hba_default:
# "local" is for Unix domain socket connections only
- type: local
  database: all
  user: all
  address: ''
  method: peer
# IPv4 local connections
- type: host
  database: all
  user: all
  address: 127.0.0.1/32
  method: md5
# IPv6 local connections
- type: host
  database: all
  user: all
  address: ::1/128
  method: md5
# Allow replication connections from localhost, by a user with the
# replication privilege.
- type: local
  database: replication
  user: all
  address: ''
  method: peer
- type: host
  database: replication
  user: all
  address: 127.0.0.1/32
  method: md5
- type: host
  database: replication
  user: all
  address: ::1/128
  method: md5

postgresql__server_hba_local:
# DO NOT DISABLE!
# If you change this first entry you will need to make sure that the
# database superuser can access the database using some other method.
# Noninteractive access to all databases is required during automatic
# maintenance (custom daily cronjobs, replication, and similar tasks).
#
# Database administrative login by Unix domain socket
- type: local
  database: all
  user: postgres
  address: ''
  method: peer

postgresql__server_hba_combined: "{{ postgresql__server_hba_local + postgresql__server_hba }}"
