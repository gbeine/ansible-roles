---
# defaults file for roles/pki

pki_packages: []
pki_acme_packages: []

# Substitutions
#

pki__enable: "{{ pki_enable | default(false) }}"

pki__realms: "{{ pki_realms | default([]) }}"

pki__acme_enable: "{{ pki_acme_enable | default(false) }}"
pki__acme_email: "{{ pki_acme_email | default('') }}"
pki__acme_provider: "{{ pki_acme_provider | default('acme-staging-v02') }}"
pki__acme_webserver: "{{ pki_acme_webserver | default('nginx') }}"

pki__easyrsa_enable: "{{ pki_easyrsa_enable | default(false) }}"
pki__easyrsa_path: "{{ pki_easyrsa_path | default(pki__easyrsa_path_default) }}"

pki__easyrsa_dn: "{{ pki_easyrsa_dn | default('cn_only') }}"
pki__easyrsa_req_cn: "{{ pki_easyrsa_req_cn | default('ChangeMe') }}"
pki__easyrsa_req_country: "{{ pki_easyrsa_req_country | default('US') }}"
pki__easyrsa_req_province: "{{ pki_easyrsa_req_province | default('California') }}"
pki__easyrsa_req_city: "{{ pki_easyrsa_req_city | default('San Francisco') }}"
pki__easyrsa_req_org: "{{ pki_easyrsa_req_org | default('Copyleft Certificate Co') }}"
pki__easyrsa_req_email: "{{ pki_easyrsa_req_email | default('me@example.net') }}"
pki__easyrsa_req_ou: "{{ pki_easyrsa_req_ou | default('My Organizational Unit') }}"
pki__easyrsa_key_size: "{{ pki_easyrsa_size | default(2048) }}"
pki__easyrsa_algo: "{{ pki_easyrsa_algo | default('rsa') }}"
pki__easyrsa_curve: "{{ pki_easyrsa_curve | default('secp384r1') }}"
pki__easyrsa_ca_exprire: "{{ pki_easyrsa_ca_expire | default(3650) }}"
pki__easyrsa_cert_expire: "{{ pki_easyrsa_cert_expire | default(825) }}"
pki__easyrsa_crl_days: "{{ pki_easyrsa_crl_days | default(180) }}"
pki__easyrsa_cert_renew: "{{ pki_easyrsa_cert_renew | default(30) }}"
pki__easyrsa_rand_sn: "{{ pki_easyrsa_rand_sn | default('yes') }}"
pki__easyrsa_ns_support: "{{ pki_easyrsa_ns_support | default('no') }}"
pki__easyrsa_ns_comment: "{{ pki_easyrsa_ns_comment | default('Easy-RSA Generated Certificate') }}"
pki__easyrsa_digest: "{{ pki_easyrsa_digest | default('sha256') }}"
pki__easyrsa_password: "{{ vault__pki__easyrsa_password }}"

#
# Do not change from here
#

pki__root_dir: /etc/pki
pki__acme_dir: /etc/letsencrypt
pki__acme_accounts_dir: "{{ pki__acme_dir }}/accounts"
pki__acme_renewal_dir: "{{ pki__acme_dir }}/renewal"
pki__realms_dir: "{{ pki__root_dir }}/realms"
pki__secrets_dir: "{{ pki__secrets_dir_default }}"

pkg__acme_webserver_selected: "{{ pki__acme_webserver_map[pki__acme_webserver] | default({'options': '', 'packages': []})}}"

pki__acme_global_options: "--server {{ pki__acme_provider_map[pki__acme_provider] }}"
pki__acme_register_options: "{{ pki__acme_global_options }} --email {{ pki__acme_email }} --agree-tos --no-eff-email"
pki__acme_webserver_options: "{{ pkg__acme_webserver_selected['options'] | default('') }}"

pki__acme_environment: {}

pki__easyrsa_environment:
  EASYRSA_PKI: "{{ pki__secrets_dir }}"
  EASYRSA_DN: "{{ pki__easyrsa_dn }}"
  EASYRSA_REQ_CN: "{{ pki__easyrsa_req_cn }}"
  EASYRSA_REQ_COUNTRY: "{{ pki__easyrsa_req_country }}"
  EASYRSA_REQ_PROVINCE: "{{ pki__easyrsa_req_province }}"
  EASYRSA_REQ_CITY: "{{ pki__easyrsa_req_city }}"
  EASYRSA_REQ_ORG: "{{ pki__easyrsa_req_org }}"
  EASYRSA_REQ_EMAIL: "{{ pki__easyrsa_req_email }}"
  EASYRSA_REQ_OU: "{{ pki__easyrsa_req_ou }}"
  EASYRSA_KEY_SIZE: "{{ pki__easyrsa_key_size }}"
  EASYRSA_ALGO: "{{ pki__easyrsa_algo }}"
  EASYRSA_CURVE: "{{ pki__easyrsa_curve }}"
  EASYRSA_CA_EXPIRE: "{{ pki__easyrsa_ca_exprire }}"
  EASYRSA_CERT_EXPIRE: "{{ pki__easyrsa_cert_expire }}"
  EASYRSA_CRL_DAYS: "{{ pki__easyrsa_crl_days }}"
  EASYRSA_CERT_RENEW: "{{ pki__easyrsa_cert_renew }}"
  EASYRSA_RAND_SN: "{{ pki__easyrsa_rand_sn }}"
  EASYRSA_NS_SUPPORT: "{{ pki__easyrsa_ns_support }}"
  EASYRSA_NS_COMMENT: "{{ pki__easyrsa_ns_comment }}"
  EASYRSA_DIGEST: "{{ pki__easyrsa_digest }}"
  EASYRSA_BATCH: yes
  EASYRSA_PASSIN: "pass:{{ pki__easyrsa_password }}"
  EASYRSA_PASSOUT: "pass:{{ pki__easyrsa_password }}"

pki__public_group: root
pki__public_dir_mode: '0755'
pki__public_file_mode: '0644'
pki__private_group: ssl-cert
pki__private_dir_mode: '0750'
pki__private_file_mode: '0640'

pki__acme_provider_map:
  acme-v02: https://acme-v02.api.letsencrypt.org/directory
  acme-staging-v02: https://acme-staging-v02.api.letsencrypt.org/directory

pki__acme_webserver_map:
  nginx:
    options: --nginx
    packages:
    - python3-certbot-nginx

pki__realm_structure:
- name: config
  owner: root
  group: "{{ pki__public_group }}"
  mode: "{{ pki__public_dir_mode }}"
- name: private
  owner: root
  group: "{{ pki__private_group }}"
  mode: "{{ pki__private_dir_mode }}"
- name: public
  owner: root
  group: "{{ pki__public_group }}"
  mode: "{{ pki__public_dir_mode }}"

pki__secrets_dir_default: "{{ inventory_dir }}/secrets/pki"
pki__easyrsa_path_default: /usr/bin/easyrsa

pki__packages_default:
- acl
- ca-certificates
- gnutls-bin
- openssl
- ssl-cert

pki__acme_packages_default:
- certbot
- python3-icu

pki__acme_packages_webserver: "{{ pki__acme_webserver_map[pki__acme_webserver].packages | default([]) }}"

pki__packages_combined: "{{ pki_packages + pki__packages_default }}"
pki__acme_packages_combined: "{{ pki_acme_packages + pki__acme_packages_default + pkg__acme_webserver_selected['packages'] }}"
