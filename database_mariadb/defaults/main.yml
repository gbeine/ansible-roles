---

database_mariadb__accounts: "{{ mysql_accounts | default ([]) }}"
database_mariadb__databases: "{{ mysql_databases | default ([]) }}"
database_mariadb__password: "{{ vault__mariadb_password_list[dns_hostname] | default({}) }}"

database_mariadb__use_podman: "{{ mysql_use_podman | default(false) }}"

database_mariadb__podman_hostname: "{{ mysql_pod_name | default('mariadb.' + dns_hostname) }}"
database_mariadb__podman_ip: "{{ mysql_pod_ip | mandatory }}"
database_mariadb__podman_network: "{{ mysql_pod_net | mandatory }}"
database_mariadb__podman_uid: "{{ podman__users.mariadb.uid | mandatory }}"
database_mariadb__podman_gid: "{{ podman__users.mariadb.gid | mandatory }}"
database_mariadb__podman_home: "{{ podman__users.mariadb.home | mandatory }}"
database_mariadb__podman_database: "{{ mysql_pod_database | mandatory }}"
database_mariadb__podman_user: "{{ mysql_pod_user | default(database_mariadb__podman_database) }}"

#
# Defaults - do not change
#

database_mariadb__server_password_reset: "mysql -e 'SET PASSWORD = PASSWORD(\"{{ database_mariadb__password.root }}\"); FLUSH PRIVILEGES;' || mysql --password={{ database_mariadb__password.root }} -e 'SET PASSWORD = PASSWORD(\"{{ database_mariadb__password.root }}\"); FLUSH PRIVILEGES;'"

# this configuration is used when MySQL/MariaDB is installed as a podman container
database_mariadb__podman_default:
  - name: mariadb
    hostname: "{{ database_mariadb__podman_hostname }}"
    image: 'lscr.io/linuxserver/mariadb:latest'
    ip: "{{ database_mariadb__podman_ip }}"
    network: "{{ database_mariadb__podman_network }}"
    restart_policy: always
    environment:
      - PUID: "{{ database_mariadb__podman_uid }}"
      - PGID: "{{ database_mariadb__podman_gid }}"
      - MYSQL_ROOT_PASSWORD: "{{ vault__mariadb_password_list[database_mariadb__podman_hostname]['root'] }}"
      - MYSQL_DATABASE: "{{ database_mariadb__podman_database }}"
      - MYSQL_USER: "{{ database_mariadb__podman_user }}"
      - MYSQL_PASSWORD: "{{ vault__mariadb_password_list[database_mariadb__podman_hostname][database_mariadb__podman_user] }}"
    volumes:
      - "{{ database_mariadb__podman_home }}:/config"
    expose:
      - 3306

database_mariadb__podman_packages: "{{ database_mariadb__podman_packages_default[bootstrap_ansible__distribution] | default([]) }}"

database_mariadb__podman_packages_default:
  Debian:
    - libmariadb3
    - python3-pymysql


# this configuration is used when MySQL/MariaDB is installed via package management
database_mariadb__packages: "{{ database_mariadb__packages_default[bootstrap_ansible__distribution] | default([]) }}"

database_mariadb__packages_default:
  Debian:
    - dbconfig-common
    - dbconfig-mysql
    - default-mysql-client
    - default-mysql-server
    - mariadb-client
    - mariadb-server
    - mariadb-common
    - libdbd-mariadb-perl
    - python3-pymysql
    - python3-cryptography
