---

#
# Substitutes - do not change
#

database_mariadb__accounts: "{{ mysql_accounts | default ([]) }}"
database_mariadb__databases: "{{ mysql_databases | default ([]) }}"
database_mariadb__password: "{{ vault__mariadb_password_list[dns_hostname] | default({}) }}"

database_mariadb__use_podman: "{{ mysql_use_podman | default(false) }}"

database_mariadb__podman_hostname: "{{ mysql_pod_hostname | default('mariadb.' + dns_hostname) }}"
database_mariadb__podman_ip: "{{ mysql_pod_ip | mandatory }}"
database_mariadb__podman_network: "{{ mysql_pod_net | mandatory }}"
database_mariadb__podman_uid: "{{ mysql_pod_uid | mandatory }}"
database_mariadb__podman_gid: "{{ mysql_pod_gid | mandatory }}"
database_mariadb__podman_home: "{{ mysql_pod_home | mandatory }}"
database_mariadb__podman_root_pass: "{{ mysql_pod_root_pass | mandatory }}"

database_mariadb__connect_via_socket: "{{ mysql_connect_via_socket | default(true) }}"
database_mariadb__port: "{{ mysql_port | default(3306) }}"
database_mariadb__socket: "{{ mysql_socket | default( database_mariadb__run_dir + '/mysqld.sock') }}"
database_mariadb__pid_file: "{{ mysql_pid_file | default( database_mariadb__run_dir + '/mysqld.pid') }}"
database_mariadb__user: "{{ mysql_user | default('mysql') }}"
database_mariadb__bind_address: "{{ mysql_bind_address | default('127.0.0.1') }}"

database_mariadb__key_buffer_size: "{{ mysql_key_buffer_size | default('128M') }}"
database_mariadb__max_allowed_packet: "{{ mysql_max_allowed_packet | default('16M') }}"
database_mariadb__thread_stack: "{{ mysql_thread_stack | default('192K') }}"
database_mariadb__thread_cache_size: "{{ mysql_thread_cache_size | default(8) }}"
database_mariadb__max_connections: "{{ mysql_thread_cache_size | default(100) }}"
database_mariadb__table_cache: "{{ mysql_thread_cache_size | default(64) }}"
database_mariadb__character_set_server: "{{ mysql_character_set_server | default('utf8mb4') }}"
database_mariadb__collation_server: "{{ mysql_collation_server | default('utf8mb4_general_ci') }}"

database_mariadb__innodb_buffer_pool_size: "{{ mysql_innodb_buffer_pool_size | default('8G') }}"

#
# Defaults - do not change
#

database_mariadb__server_password_reset: "mysql -e 'SET PASSWORD = PASSWORD(\"{{ database_mariadb__password.root }}\"); FLUSH PRIVILEGES;' || mysql --password={{ database_mariadb__password.root }} -e 'SET PASSWORD = PASSWORD(\"{{ database_mariadb__password.root }}\"); FLUSH PRIVILEGES;'"

database_mariadb__etc_dir: /etc/mysql
database_mariadb__run_dir: /run/mysqld
database_mariadb__data_dir: /var/lib/mysql
database_mariadb__base_dir: /usr
database_mariadb__tmp_dir: /tmp

database_mariadb__podman_container: "{{ database_mariadb__podman_container_default }}"

# this configuration is used when MySQL/MariaDB is installed as a podman container
database_mariadb__podman_container_default:
  name: mariadb
  hostname: "{{ database_mariadb__podman_hostname }}"
  image: 'lscr.io/linuxserver/mariadb:latest'
  ip: "{{ database_mariadb__podman_ip }}"
  network: "{{ database_mariadb__podman_network }}"
  restart_policy: always
  environment:
    - PUID: "{{ database_mariadb__podman_uid }}"
    - PGID: "{{ database_mariadb__podman_gid }}"
    - MYSQL_ROOT_PASSWORD: "{{ vault__mariadb_password_list[database_mariadb__podman_hostname]['root'] }}"
  volumes:
    - "{{ database_mariadb__podman_home }}:/config"

database_mariadb__podman_account: "{{ database_mariadb__podman_account_default }}"

database_mariadb__podman_account_default:
  user: mariadb
  uid: "{{ database_mariadb__podman_uid }}"
  gid: "{{ database_mariadb__podman_gid }}"
  home: "{{ database_mariadb__podman_home }}"

database_mariadb__podman_packages: "{{ database_mariadb__podman_packages_default[bootstrap_ansible__distribution] | default([]) }}"

database_mariadb__podman_packages_default:
  Debian:
    - libmariadb3
    - python3-pymysql

# this configuration is used when MySQL/MariaDB is installed via package management
database_mariadb__packages: "{{ database_mariadb__packages_default[bootstrap_ansible__distribution] | default([]) }}"

database_mariadb__packages_default:
  Debian:
    - dbconfig-common
    - dbconfig-mysql
    - default-mysql-client
    - default-mysql-server
    - mariadb-client
    - mariadb-server
    - mariadb-common
    - libdbd-mariadb-perl
    - python3-pymysql
    - python3-cryptography
