---
# defaults file for roles/mysql

mysql_client_packages: []
mysql_server_packages: []

#
# Substitutions
#

mysql__enable: "{{ mysql_enable | default (false) }}"
mysql__client_enable: "{{ mysql_client_enable | default (mysql__enable or mysql__server_enable) }}"
mysql__server_enable: "{{ mysql_server_enable | default (mysql__enable) }}"
mysql__accounts: "{{ mysql_accounts | default ([]) }}"
mysql__databases: "{{ mysql_databases | default ([]) }}"
mysql__password: "{{ vault__mysql_password | default({}) }}"

mysql__etc_dir: "{{ mysql_etc_dir | default('/etc/mysql') }}"
mysql__data_dir: "{{ mysql_data_dir | default('/var/lib/mysql') }}"
mysql__log_dir: "{{ mysql_log_dir | default('/var/log/mysql') }}"
mysql__run_dir: "{{ mysql_run_dir | default('/var/run/mysqld') }}"
mysql__tmp_dir: "{{ mysql_tmp_dir | default('/tmp') }}"

mysql__server_character_set_server: "{{ mysql_server_character_set_server | default('utf8mb4') }}"
mysql__server_collation_server: "{{ mysql_server_collation_server | default('utf8mb4_0900_ai_ci') }}"
mysql__server_default_storage_engine: "{{ mysql_server_default_storage_engine | default('InnoDB') }}"
mysql__server_innodb_log_file_size: "{{ mysql_server_innodb_log_file_size | default('50M') }}"
mysql__server_sql_mode: "{{ mysql_server_sql_mode | default(['ONLY_FULL_GROUP_BY', 'STRICT_TRANS_TABLES', 'NO_ZERO_IN_DATE', 'NO_ZERO_DATE', 'ERROR_FOR_DIVISION_BY_ZERO', 'NO_ENGINE_SUBSTITUTION']) }}"
mysql__server_transaction_isolation: "{{ mysql_server_transaction_isolation | default('REPEATABLE-READ') }}"
mysql__server_binlog_format: "{{ mysql_server_binlog_format | default('ROW') }}"
mysql__server_log_bin_trust_function_creators: "{{ mysql_server_log_bin_trust_function_creators | default(false) }}"
mysql__server_optimizer_switch: "{{ mysql_server_optimizer_switch | default({}) }}"

mysql__server_user: "{{ mysql_server_user | default('mysql') }}"
mysql__server_pid_file: "{{ mysql_server_pid_file | default(mysql__run_dir + '/mysqld.pid') }}"
mysql__server_socket: "{{ mysql_server_socket | default(mysql__run_dir + '/mysqld.sock') }}"
mysql__server_port: "{{ mysql_server_port | default(3306) }}"
mysql__server_data_dir: "{{ mysql_server_data_dir | default(mysql__data_dir) }}"
mysql__server_tmp_dir: "{{ mysql_server_tmp_dir | default(mysql__tmp_dir) }}"
mysql__server_bind_address: "{{ mysql_server_bind_address | default('127.0.0.1') }}"
mysql__server_mysqlx_bind_address: "{{ mysql_server_mysqlx_bind_address | default('127.0.0.1') }}"
mysql__server_key_buffer_size: "{{ mysql_server_key_buffer_size | default('16M') }}"
mysql__server_max_allowed_packet: "{{ mysql_server_max_allowed_packet | default('64M') }}"
mysql__server_thread_stack: "{{ mysql_server_thread_stack | default('256K') }}"
mysql__server_thread_cache_size: "{{ mysql_server_thread_cache_size | default(-1) }}"
mysql__server_myisam_recover_options: "{{ mysql_server_myisam_recover_options | default('BACKUP') }}"
mysql__server_max_connections: "{{ mysql_server_max_connections | default(151) }}"
mysql__server_table_open_cache: "{{ mysql_server_max_connections | default(4000) }}"
mysql__server_general_log_file: "{{ mysql_server_general_log_file | default(mysql__log_dir + '/query.log') }}"
mysql__server_general_log: "{{ mysql_server_general_log | default(false) }}"
mysql__server_log_error: "{{ mysql_server_general_log | default(mysql__log_dir + '/error.log') }}"
mysql__server_slow_query_log_file: "{{ mysql_server_general_log_file | default(mysql__log_dir + '/mysql-slow.log') }}"
mysql__server_slow_query_log: "{{ mysql_server_slow_query_log | default(false) }}"
mysql__server_long_query_time: "{{ mysql_server_long_query_time | default(2) }}"
mysql__server_log_queries_not_using_indexes: "{{ mysql_server_log_queries_not_using_indexes | default(false) }}"
mysql__server_server_id: "{{ mysql_server_server_id | default(1) }}"
mysql__server_log_bin: "{{ mysql_server_log_bin | default(mysql__log_dir + '/mysql-bin.log') }}"
mysql__server_binlog_expire_logs_seconds: "{{ mysql_server_binlog_expire_logs_seconds | default(2592000) }}"
mysql__server_max_binlog_size: "{{ mysql_server_max_binlog_size | default('100M') }}"
mysql__server_binlog_do_db: "{{ mysql_server_binlog_do_db | default([]) }}"
mysql__server_binlog_ignore_db: "{{ mysql_server_binlog_ignore_db | default([]) }}"

mysql__flavor: "{{ mysql_flavor | default('mariadb') }}"

#
# Do not change from here
#

mysql__client_packages_default: "{{ mysql__client_packages_flavors[mysql__flavor] }}"

mysql__client_packages_flavors:
  mariadb:
  - mariadb-client
  mysql80:
  - mysql-client
  - mysql-client-8.0

mysql__server_packages_default:  "{{ mysql__server_packages_flavors[mysql__flavor] }}"

mysql__server_packages_flavors:
  mariadb:
  - mariadb-server
  - python3-pymysql
  - python3-cryptography
  - libdbd-mariadb-perl
  mysql80:
  - mysql-server
  - mysql-server-8.0
  - python3-pymysql
  - python3-cryptography

mysql__server_password_reset:
  mariadb: "mysql -e 'SET PASSWORD = PASSWORD(\"{{ mysql__password.root }}\"); FLUSH PRIVILEGES;' || mysql --password={{ mysql__password.root }} -e 'SET PASSWORD = PASSWORD(\"{{ mysql__password.root }}\"); FLUSH PRIVILEGES;'"
#  mysql80: "/usr/bin/mysql --defaults-file=/etc/mysql/debian.cnf -e 'ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY \"{{ mysql__password.root }}\"; FLUSH PRIVILEGES;'"
#  mysql80: "mysql -e 'SET PASSWORD = \"{{ mysql__password.root }}\"; FLUSH PRIVILEGES;' || mysql --password={{ mysql__password.root }} -e 'SET PASSWORD = \"{{ mysql__password.root }}\"; FLUSH PRIVILEGES;'"

mysql__client_packages_combined: "{{ mysql__client_packages_default + mysql_client_packages}}"
mysql__server_packages_combined: "{{ mysql__server_packages_default + mysql_server_packages}}"
